# åŸºå‡†ä¸ç”Ÿå‘½å‘¨æœŸé—­ç¯æµ‹è¯• (step2_1_baseline.py)

åˆ‡æ¢è‡³script engineeræ¨¡å¼
- [ ] åˆ›å»º step2_1_baseline.py

## Python æ ¸å¿ƒé€»è¾‘ç¤ºä¾‹ (å¼•å…¥åŠ¨æ€å­¦ä¹ æœºåˆ¶)
```python
import requests, time, re, json, random

# å…¨å±€å­˜å‚¨ï¼šèµ„æºè·¯å¾„ -> å­¦ä¹ åˆ°çš„çœŸå®æ•°æ®æ¨¡æ¿
# ä¾‹å¦‚: "/system/user" -> { "userName": "admin", "phonenumber": "158...", ... }
resource_templates = {}

# 1. é˜¶æ®µä¸€ï¼šæ•°æ®æŒ–æ˜ (æ‰§è¡Œ GET æ¥å£)
def mine_real_data(base_url, token, api_list):
    print("â›ï¸ æ­£åœ¨æ‰§è¡Œæ•°æ®æŒ–æ˜ (GET)...")
    headers = {"Authorization": f"Bearer {token}"}
    
    for api in api_list:
        if api['method'] != 'GET': continue
        
        # è¿™é‡Œçš„ç­–ç•¥æ˜¯ï¼šåˆ©ç”¨ list æ¥å£è·å–çœŸå®æ•°æ®ç»“æ„
        # æ¯”å¦‚ /system/user/list -> å“åº”é‡ŒåŒ…å« rows: [{user_data}]
        try:
            resp = requests.get(f"{base_url}{api['path']}", headers=headers, params={"pageNum": 1, "pageSize": 1})
            if resp.status_code == 200:
                data = resp.json()
                # å°è¯•æå–åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡æ•°æ®ä½œä¸ºæ¨¡æ¿
                # RuoYi å¸¸è§ç»“æ„: {"rows": [...]} æˆ– {"data": [...]}
                candidates = data.get('rows') or data.get('data') or []
                if isinstance(candidates, list) and len(candidates) > 0:
                    template = candidates[0] # æ‹¿åˆ°äº†ä¸€æ¡çœŸå®å­˜åœ¨çš„ï¼ˆå¯èƒ½æ˜¯Adminçš„ï¼‰æ•°æ®
                    
                    # å»ºç«‹èµ„æºæ˜ å°„ï¼šå‡è®¾ /system/user/list çš„èµ„æº Key æ˜¯ /system/user
                    # ç®€å•çš„å»åç¼€é€»è¾‘
                    resource_key = api['path'].replace("/list", "")
                    resource_templates[resource_key] = template
                    print(f"âœ… [å­¦ä¹ æˆåŠŸ] ä» {api['path']} æå–åˆ°æ•°æ®æ¨¡æ¿")
        except Exception as e:
            pass

# 2. é˜¶æ®µäºŒï¼šè½½è·æ¸…æ´—ä¸ç”Ÿæˆ (åŸºäºæ¨¡æ¿æ„é€ æ–°æ•°æ®)
def generate_smart_payload_from_template(resource_key, original_static_payload):
    # å¦‚æœæ²¡å­¦åˆ°æ¨¡æ¿ï¼Œå°±å›é€€åˆ°é™æ€åˆ†æçš„ payload
    template = resource_templates.get(resource_key)
    if not template:
        return enrich_static_payload(original_static_payload) # å›é€€é€»è¾‘

    new_payload = template.copy()
    timestamp = str(int(time.time()))
    
    # === å…³é”®ï¼šæ¸…æ´—æ•°æ®ï¼Œç¡®ä¿è¿™æ˜¯â€œæ–°å¢â€è€Œä¸æ˜¯â€œä¿®æ”¹â€ï¼Œä¸”ä¸å†²çª ===
    
    # 1. æ¸…é™¤ä¸»é”® ID (å¼ºåˆ¶ä¸º Noneï¼Œè®©åç«¯ç”Ÿæˆ)
    for key in list(new_payload.keys()):
        if key in ['id', 'userId', 'roleId', 'deptId', 'jobId', 'postId']:
             new_payload[key] = None
    
    # 2. å”¯ä¸€åŒ–å…³é”®å­—æ®µ (é¿å¼€ Admin å’Œé‡å¤)
    for key, val in new_payload.items():
        if isinstance(val, str):
            # å¦‚æœåŸæ•°æ®æ˜¯ adminï¼Œæ”¹ä¸º auto_test_æ—¶é—´æˆ³
            if 'admin' in val.lower():
                new_payload[key] = f"auto_{timestamp}"
            # é’ˆå¯¹åç§°ã€ç¼–ç ç±»å­—æ®µï¼Œè¿½åŠ åç¼€
            elif any(k in key.lower() for k in ['name', 'code', 'key', 'title', 'phone', 'email']):
                new_payload[key] = f"test_{timestamp}_{random.randint(10,99)}"
                
    return new_payload

# è¾…åŠ©ï¼šåŸæœ¬çš„é™æ€ Payload å¤„ç† (ä½œä¸ºå…œåº•)
def enrich_static_payload(payload):
    new_payload = payload.copy()
    suffix = str(int(time.time()))
    for k, v in new_payload.items():
        if isinstance(v, str) and any(x in k.lower() for x in ['name', 'code', 'key']):
            new_payload[k] = f"{v}_{suffix}"
    return new_payload

# 3. é˜¶æ®µä¸‰ï¼šæ‰§è¡Œ POST -> DELETE é—­ç¯
def run_lifecycle_test(base_url, token, api_list):
    # å…ˆè¿è¡ŒæŒ–æ˜
    mine_real_data(base_url, token, api_list)
    
    results = []
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}

    for api in api_list:
        # åªå¤„ç† POST æ¥å£è¿›è¡Œé—­ç¯æµ‹è¯•
        if api['method'] != 'POST': continue
        
        url = f"{base_url}{api['path']}"
        
        # æ„é€  Payloadï¼šå°è¯•ä½¿ç”¨å­¦ä¹ åˆ°çš„æ¨¡æ¿
        # è¿™é‡Œçš„ resource_key éœ€è¦å’Œ GET é˜¶æ®µå¯¹åº”ï¼Œä¾‹å¦‚ /system/user
        resource_key = api['path'] 
        payload = generate_smart_payload_from_template(resource_key, api.get('smart_payload', {}))
        
        # A. æ‰§è¡Œæ–°å¢ (POST)
        try:
            # å®‰å…¨æ£€æŸ¥ï¼šå†æ¬¡ç¡®ä¿ Payload é‡Œæ²¡æœ‰ ID=1 æˆ–è€… admin
            if str(payload.get('id')) == '1' or 'admin' in str(payload.values()):
                print("âš ï¸ è­¦å‘Šï¼šPayload æ¸…æ´—å¤±è´¥ï¼Œæ£€æµ‹åˆ°æ•æ„Ÿæ•°æ®ï¼Œè·³è¿‡åˆ›å»º")
                continue

            resp = requests.post(url, headers=headers, json=payload)
            results.append({"path": api['path'], "method": "POST", "code": resp.status_code})
            
            # B. å¦‚æœæ–°å¢æˆåŠŸï¼Œæå– ID å¹¶æ‰§è¡Œåˆ é™¤ (DELETE)
            if resp.status_code == 200:
                data = resp.json()
                new_id = data.get('data', {}).get('id') or data.get('data') or data.get('id') # é€‚é…ä¸åŒè¿”å›ç»“æ„
                
                if new_id:
                    # å¯»æ‰¾å¯¹åº”çš„ DELETE æ¥å£
                    # å‡è®¾ DELETE æ¥å£è·¯å¾„ä¸º /system/user/{id}
                    delete_path = f"{api['path']}/{new_id}"
                    
                    # å†æ¬¡å®‰å…¨æ£€æŸ¥ï¼šç»å¯¹ä¸èƒ½åˆ  ID=1
                    if str(new_id) in ['1', '0']:
                        print("ğŸš« æ‹¦æˆªåˆ°åˆ é™¤ Admin ID æ“ä½œï¼Œå·²é˜»æ­¢")
                        continue
                        
                    del_resp = requests.delete(f"{base_url}{delete_path}", headers=headers)
                    results.append({"path": delete_path, "method": "DELETE", "code": del_resp.status_code, "note": "é—­ç¯æ¸…ç†"})
                    
        except Exception as e:
            results.append({"path": api['path'], "method": "POST", "code": 500, "msg": str(e)})

    return results
```

- [ ] è¯»å– {work_dir}/apis.json å¹¶è·å–ç›®æ ‡ Base URL ä¸è®¤è¯å‡­æ®ï¼ˆè‹¥è®¤è¯å‡­æ®æ¯”å¦‚tokenå¤±æ•ˆï¼Œåˆ™éœ€è¦é€šè¿‡è¿è¡Œè„šæœ¬é‡æ–°è·å–ï¼‰
## æ ¸å¿ƒé€»è¾‘ï¼š

- æºå¸¦æœ‰æ•ˆ Token å‘é€æ ‡å‡†è¯·æ±‚
  - è¯·æ±‚è‡ªé€‚åº”ï¼šè¯»å– apis.json ä¸­çš„ content_type å­—æ®µã€‚

     - è‹¥æ˜¯ multipart/form-dataï¼šæ„é€  files å‚æ•°è¿›è¡Œä¸Šä¼ æµ‹è¯•ã€‚

     - è‹¥æ˜¯ application/jsonï¼šä½¿ç”¨æå–åˆ°çš„ Smart Payloadã€‚

  - å“åº”è‡ªé€‚åº”ï¼šæ£€æŸ¥å“åº”å¤´ Content-Typeã€‚

     - è‹¥æ˜¯äºŒè¿›åˆ¶æµï¼ˆå¦‚ application/octet-stream, application/vnd.ms-excelï¼‰ï¼šåªè¦çŠ¶æ€ç æ˜¯ 200 å³åˆ¤å®šæˆåŠŸï¼Œä¸å°è¯•è§£æ JSONï¼ˆé¿å… "å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼" æŠ¥é”™ï¼‰ã€‚

- å°½é‡ä½¿ç”¨å¯¹åº”çš„ API ä¸­å®šä¹‰çš„æœ‰æ•ˆè½½è·å»å‘é€è¯·æ±‚ï¼Œå¦åˆ™å®¹æ˜“äº§ç”Ÿè„æ•°æ®æˆ–é”™è¯¯
- å®ç° parse_response é€»è¾‘ï¼šåˆ¤å®š biz_code == 200 ä¸ºé€šè¿‡
- è®°å½• biz_msg ä½œä¸ºåŠŸèƒ½æ­£å¸¸çš„è¯æ®

## å¾…æ‰§è¡ŒæŒ‡ä»¤
- [ ] è¯»å– {work_dir}/apis.json è·å–ç›®æ ‡ä¿¡æ¯ã€‚

- [ ] Step 1: é€†å‘å­¦ä¹  (Reverse Learning)

   - éå†æ‰€æœ‰ GET ç±»å‹æ¥å£ï¼ˆç‰¹åˆ«æ˜¯ /list ç»“å°¾çš„ï¼‰ã€‚

   - å‘é€è¯·æ±‚å¹¶è§£æå“åº”ä¸­çš„ rows æˆ– data æ•°ç»„ã€‚

   - æå–ç¬¬ä¸€æ¡æœ‰æ•ˆæ•°æ®ï¼ˆå³ä½¿æ˜¯ Admin æ•°æ®ï¼‰ä½œä¸ºè¯¥æ¨¡å—çš„â€œé»„é‡‘æ¨¡æ¿ (Golden Template)â€ã€‚

- [ ] Step 2: è½½è·é‡æ„ (Payload Reconstruction)

   - å°†å­¦ä¹ åˆ°çš„æ¨¡æ¿å†™å…¥å†…å­˜æ˜ å°„ã€‚

   - é’ˆå¯¹ POST æ¥å£ï¼ŒåŸºäºæ¨¡æ¿ç”Ÿæˆ Payloadï¼Œä½†å¿…é¡»æ‰§è¡Œè„±æ•ä¸å”¯ä¸€åŒ–ï¼š

   - ç½®ç©º IDï¼šç¡®ä¿åç«¯è¯†åˆ«ä¸ºâ€œæ–°å¢â€æ“ä½œã€‚

   - é‡å‘½åï¼šå°† admin æ”¹ä¸º auto_testï¼Œå°† name å­—æ®µè¿½åŠ æ—¶é—´æˆ³ã€‚

- [ ] Step 3: å¢åˆ é—­ç¯ (Create-Delete Loop)

   - ä½¿ç”¨é‡æ„åçš„ Payload å‘é€ POST è¯·æ±‚ã€‚

   - è‹¥æˆåŠŸ (200)ï¼Œæå–è¿”å›çš„ new_idã€‚

   - ç«‹å³æ„é€  DELETE è¯·æ±‚æ¸…ç†è¯¥ IDï¼ˆä¸¥ç¦åˆ é™¤ ID=1/adminï¼‰ã€‚

- [ ] è¾“å‡ºï¼šå†™å…¥ {work_dir}/results_baseline.jsonï¼Œå¹¶å°†å­¦ä¹ åˆ°çš„é«˜è´¨é‡ Payload æ›´æ–°å› {work_dir}/apis.json ä»¥ä¾›åç»­ Fuzz æµ‹è¯•ä½¿ç”¨ã€‚

## åˆ‡æ¢è‡³debuggeræ¨¡å¼

- [ ] æµç¨‹è‡ªæ£€ï¼šToken å¤±æ•ˆé‡è¿ã€æ—¥å¿—è„±æ•ã€‚