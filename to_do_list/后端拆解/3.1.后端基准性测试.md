# åŸºå‡†ä¸ç”Ÿå‘½å‘¨æœŸé—­ç¯æµ‹è¯• (step2_1_baseline.py)

åˆ‡æ¢è‡³script engineeræ¨¡å¼
- [ ] åˆ›å»º step2_1_baseline.pyï¼Œå†™å…¥ä»¥ä¸‹å…¨é‡ä»£ç ã€‚

## Python æ ¸å¿ƒé€»è¾‘ç¤ºä¾‹

```python
import requests, json, re, time

# ğŸŒŸ å…¨å±€ç»Ÿä¸€é»„é‡‘è½½è· (æ‰€æœ‰æµ‹è¯•ç»´åº¦çš„åŸºå‡†)
GOLDEN_PAYLOADS = {
    "/system/user": {
        "POST": {"userName": "Auto_{ts}", "nickName": "Robot", "password": "admin123", "status": "0", "deptId": 103, "roleIds": [2]},
        "PUT": {"userId": "{id}", "email": "test_{ts}@qq.com", "nickName": "Robot_Upd"}
    },
    "/system/role": {
        "POST": {"roleName": "Role_{ts}", "roleKey": "k_{ts}", "roleSort": 1, "status": "0", "menuIds": [1], "menuCheckStrictly": True},
        "PUT": {"roleId": "{id}", "roleName": "Role_{ts}_Upd", "menuIds": [1], "menuCheckStrictly": True}
    },
    "/system/dept": {
        "POST": {"parentId": 100, "deptName": "Dept_{ts}", "orderNum": 1, "status": "0", "email": "d@t.com"},
        "PUT": {"deptId": "{id}", "deptName": "Dept_{ts}_Upd"}
    },
    "/system/post": {
        "POST": {"postCode": "pc_{ts}", "postName": "Post_{ts}", "postSort": 1, "status": "0"},
        "PUT": {"postId": "{id}", "postName": "Post_{ts}_Upd"}
    },
    "/system/config": {
        "POST": {"configName": "Cfg_{ts}", "configKey": "k.{ts}", "configValue": "v1", "configType": "Y"},
        "PUT": {"configId": "{id}", "configValue": "v2"}
    }
}

def get_sample_id(base_url, token, resource_path):
    headers = {"Authorization": f"Bearer {token}"}
    try:
        url = f"{base_url}{resource_path}/list"
        resp = requests.get(url, headers=headers, params={"pageNum":1, "pageSize":5}, timeout=5)
        if resp.status_code == 200:
            rows = resp.json().get('rows', [])
            for row in rows:
                rid = row.get('userId') or row.get('roleId') or row.get('deptId') or row.get('postId') or row.get('configId') or row.get('id')
                if rid and str(rid) != "1" and str(rid) != "100": return rid
    except: pass
    return None

def run_test(base_url, token, api_list):
    results = []
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    
    resource_groups = {}
    sorted_apis = sorted(api_list, key=lambda x: len(x['path']))
    for api in sorted_apis:
        path = api['path']
        base = re.sub(r'/\{.*?\}', '', path)
        base = re.sub(r'/(list|export|import|profile|authRole|changeStatus|resetPwd|data).*', '', base)
        if base not in resource_groups: resource_groups[base] = {}
        if api['method'] not in resource_groups[base]: resource_groups[base][api['method']] = api

    for base, methods in resource_groups.items():
        # GET
        if 'GET' in methods:
            try:
                url = f"{base_url}{methods['GET']['path']}"
                if "{" not in url:
                    resp = requests.get(url, headers=headers, params={"pageNum":1})
                    results.append({"path": url, "method": "GET", "code": resp.status_code, "status": "SUCCESS" if resp.status_code==200 else "FAILED"})
            except: pass

        # POST -> PUT -> DELETE
        if 'POST' in methods:
            ts = str(int(time.time()))[-4:]
            created_id = None
            url = f"{base_url}{methods['POST']['path']}"
            
            # åŒæºç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨é»„é‡‘è½½è·
            payload = GOLDEN_PAYLOADS.get(base, {}).get("POST") or methods['POST'].get('smart_payload', {})
            
            if payload:
                payload = json.loads(json.dumps(payload).replace("{ts}", ts))
                try:
                    resp = requests.post(url, headers=headers, json=payload)
                    if resp.status_code == 200 and resp.json().get('code') == 200:
                        results.append({"path": url, "method": "POST", "code": 200, "status": "SUCCESS"})
                        tmp = resp.json().get('data')
                        if isinstance(tmp, dict): created_id = tmp.get('id')
                        elif isinstance(tmp, (int, str)): created_id = tmp
                    else:
                        results.append({"path": url, "method": "POST", "code": resp.status_code, "status": "FAILED"})
                except: pass
            
            # PUT
            target_id = created_id or get_sample_id(base_url, token, base)
            if 'PUT' in methods and target_id:
                url = f"{base_url}{methods['PUT']['path']}"
                payload = GOLDEN_PAYLOADS.get(base, {}).get("PUT") or methods['PUT'].get('smart_payload', {})
                if payload:
                    payload = json.loads(json.dumps(payload).replace("{ts}", ts).replace("{id}", str(target_id)))
                    # å…œåº•æ³¨å…¥
                    has_id = any(k.lower().endswith("id") for k in payload.keys())
                    if not has_id: payload['id'] = target_id
                    try:
                        resp = requests.put(url, headers=headers, json=payload)
                        results.append({"path": url, "method": "PUT", "code": resp.status_code, "status": "SUCCESS" if resp.json().get('code')==200 else "FAILED"})
                    except: pass
            
            # DELETE
            if 'DELETE' in methods and target_id:
                url = re.sub(r'\{.*?\}', str(target_id), f"{base_url}{methods['DELETE']['path']}")
                if str(target_id) not in ["1", "100"]:
                    try:
                        resp = requests.delete(url, headers=headers)
                        # ä¸šåŠ¡æ‹¦æˆªè§†ä¸º Pass
                        is_ok = resp.json().get('code') == 200 or "ä¸å…è®¸" in str(resp.json().get('msg'))
                        results.append({"path": url, "method": "DELETE", "code": resp.status_code, "status": "SUCCESS" if is_ok else "FAILED"})
                    except: pass

    return results

    ```
    