# è¶Šæƒ/é‰´æƒç»•è¿‡æµ‹è¯• (step2_2_auth.py)

åˆ‡æ¢è‡³script engineeræ¨¡å¼
- [ ] åˆ›å»º step2_2_auth.py

## Python æ ¸å¿ƒé€»è¾‘ç¤ºä¾‹
```python
import requests, re, random, json

# è¾…åŠ©å‡½æ•°ï¼šåŠ¨æ€å¡«å……è·¯å¾„å‚æ•°
def fill_path_params(url, id_pool):
    # åŠ¨æ€å¡«å……è·¯å¾„å‚æ•°ï¼Œç¡®ä¿æµ‹è¯•è¯·æ±‚æœ‰æ•ˆ
    matches = re.findall(r'\{(.*?)\}', url)
    for param in matches:
        # ä» id_pool æ‰¾å¯¹åº”å€¼ (å¿½ç•¥å¤§å°å†™åŒ¹é…)
        valid_values = []
        for k, v in id_pool.items():
            if param.lower() in k.lower():
                valid_values = v
                break
        
        if valid_values:
            val = random.choice(valid_values)
            url = url.replace(f"{{{param}}}", str(val))
        else:
            # æ²¡æ‰¾åˆ° ID å°±ä¿æŒåŸæ ·æˆ–å¡« 1 (åç»­ä¼šè¢« Admin Shield æ‹¦æˆª)
            url = url.replace(f"{{{param}}}", "1")
    return url

def run_auth_bypass(base_url, api_list):
    results = []
    
    # 1. æå–å…¨å±€ ID æ±  (ä» apis.json ä¸­èšåˆ)
    global_id_pool = {} 
    for api in api_list:
        if 'id_pool' in api and api['id_pool']: 
            global_id_pool.update(api['id_pool'])

    for api in api_list:
        method = api['method']
        
        # 2. åŠ¨æ€å¡«å…… URL
        raw_url = f"{base_url}{api['path']}"
        url = fill_path_params(raw_url, global_id_pool)
        
        # === å®‰å…¨é˜²å¾¡ (Admin Shield) ===
        # é’ˆå¯¹ DELETE/PUTï¼Œå¦‚æœ URL æœ€ç»ˆæŒ‡å‘äº†æ•æ„Ÿ ID (1/0/admin)ï¼Œå¼ºåˆ¶è·³è¿‡
        if method in ['DELETE', 'PUT']:
            if any(x in url for x in ['/1', '/0', '/admin', '/root']):
                print(f"ğŸ›¡ï¸ [Shield] è·³è¿‡æ•æ„Ÿèµ„æºçš„è¶Šæƒæµ‹è¯•: {url}")
                continue
        
        # 3. æ„é€ æ— é‰´æƒè¯·æ±‚ (ä¸å¸¦ Token)
        headers = {"Authorization": "Bearer invalid_token_test"}
        
        # 4. ä½¿ç”¨å®¡æŸ¥è¿‡çš„ Smart Payload (ç¡®ä¿ Body æ ¼å¼æ­£ç¡®ï¼Œèƒ½ç©¿é€å‚æ•°æ ¡éªŒ)
        payload = api.get('smart_payload', {})

        try:
            if method == 'GET':
                resp = requests.get(url, headers=headers, params=payload)
            elif method == 'POST':
                resp = requests.post(url, headers=headers, json=payload)
            elif method == 'PUT':
                resp = requests.put(url, headers=headers, json=payload)
            elif method == 'DELETE':
                resp = requests.delete(url, headers=headers)
            
            # === åˆ¤å®šæ ‡å‡† ===
            is_vuln = False
            # ä¸šåŠ¡ç  200 ä¸”çŠ¶æ€ç  200 -> ç–‘ä¼¼è¶Šæƒ
            if resp.status_code == 200:
                try:
                    data = resp.json()
                    # å‡è®¾æ ‡å‡†ä¸šåŠ¡æˆåŠŸç ä¸º 200ï¼Œä¸”è¿”å›äº†æ•°æ®
                    if data.get('code') == 200 and data.get('data') is not None: 
                        is_vuln = True
                except: pass
            
            if is_vuln:
                results.append({
                    "type": "no_auth",
                    "path": api['path'],
                    "method": method,
                    "code": 200, 
                    "msg": "ğŸ”´ è¶Šæƒæ¼æ´: æœªé‰´æƒè®¿é—®æˆåŠŸ"
                })

        except Exception as e:
            pass
            
    return results
```

## æ ¸å¿ƒé€»è¾‘ï¼š
- æ•°æ®æºä¾èµ–ï¼šå¿…é¡»è¯»å–ç»è¿‡åŸºå‡†æµ‹è¯•æ›´æ–°åçš„ apis.jsonï¼Œä»ä¸­è·å– smart_payload å’Œ id_poolã€‚

- åŠ¨æ€è·¯å¾„å¡«å……ï¼šæµ‹è¯•å‰å¿…é¡»è§£æ URL ä¸­çš„ {id} å ä½ç¬¦ï¼Œå¹¶ç”¨ id_pool ä¸­çš„çœŸå® ID æ›¿æ¢ï¼Œç¡®ä¿æµ‹è¯•æœ‰æ•ˆæ€§ã€‚

- Admin Shieldï¼šåœ¨ URL å¡«å……åï¼Œå†æ¬¡æ£€æŸ¥æ˜¯å¦å‘½ä¸­äº†ç®¡ç†å‘˜ ID (1/0)ï¼Œè‹¥æ˜¯åˆ™è·³è¿‡ DELETE/PUT æµ‹è¯•ã€‚

- åˆ¤å®šæ ‡å‡†ï¼šHTTP 200 + ä¸šåŠ¡ Code 200 = é«˜å±æ¼æ´ã€‚

- è¾“å‡ºï¼šå†™å…¥ {work_dir}/results_auth_bypass.jsonã€‚
## åˆ‡æ¢è‡³debuggeræ¨¡å¼

- [ ] æµç¨‹è‡ªæ£€ï¼šç¡®è®¤ URL ä¸­çš„ {} å ä½ç¬¦å·²è¢«æ›¿æ¢ä¸ºæ•°å­—ã€‚

- [ ] è„±æ•å¤„ç†ï¼šæ—¥å¿—è„±æ•ã€‚