# ğŸŸ¢ ä»»åŠ¡ä¸€ï¼šå¤šè¯­è¨€ API æå– (step1_extract.py)

## ğŸ“ å¾…æ‰§è¡ŒæŒ‡ä»¤ï¼š
- [ ] ç¡®è®¤ä¸Šä¸€æ­¥éª¤ä¸­æ‰€å¾—åˆ°çš„æ¨¡å‹è¯†åˆ«ç»“æœï¼Œç¡®å®šå½“å‰éœ€è¦è¯†åˆ«çš„ API è¯­è¨€ï¼Œåœ¨è¿™ä¸€æ­¥éª¤ä»…å®ŒæˆæŒ‡å®šè¯­è¨€çš„API æå–(è„šæœ¬ä¸­ä¸æ¶‰åŠåˆ°å…¶ä»–è¯­è¨€çš„APIæå–é€»è¾‘)
- [ ] åˆ›å»º `step1_extract.py`
- [ ] å°†æœ€åˆä¼ å…¥çš„æºä»£ç æ ¹ç›®å½•è·¯å¾„ç¡¬ç¼–ç è¿›å‡½æ•°ä¸­
- [ ] å®ç°ä¸»å‡½æ•°ï¼ˆæ”¯æŒ Java ç­‰ï¼‰
- [ ] **æ ¸å¿ƒå‡çº§**ï¼šä¼˜åŒ–æ­£åˆ™é€»è¾‘ï¼Œæ­£ç¡®è§£æ @PutMapping åŠ @RequestMapping ä¸­çš„ method å±æ€§
- [ ] **æ ¸å¿ƒå‡çº§**ï¼šæ”¯æŒæå–è·¯å¾„å‚æ•°å ä½ç¬¦ï¼ˆå¦‚ {userId}ï¼‰

## ğŸ› ï¸ åˆ‡æ¢è‡³ [Script Engineer æ¨¡å¼]
   - èŒè´£ï¼šå®ç°æ ¸å¿ƒè§£æé€»è¾‘ï¼Œç¡®ä¿å¤šè¯­è¨€å…¼å®¹æ€§ä¸æ•°æ®ç»“æ„ç»Ÿä¸€ã€‚

```Python

import os, re, json

# 1. æ ¸å¿ƒè§£æé€»è¾‘ï¼šæ”¯æŒä» Java æºç ä¸­é™æ€æå– API ä¿¡æ¯
def extract_java_apis(source_root):
    apis = []
    # A. åŒ¹é…ç±»è·¯å¾„: @RequestMapping("/system/user")
    class_re = re.compile(r'@RequestMapping\("?([^"]*)"?\)')
    
    # B. åŒ¹é…ç®€å†™æ³¨è§£: @GetMapping("/list"), @PutMapping, @PostMapping
    # ç»„1: Method (Get/Post/Put/Delete)
    # ç»„2: Path (å¯èƒ½ä¸ºç©º)
    method_shorthand_re = re.compile(r'@(Get|Post|Put|Delete)Mapping(?:\("?([^"]*)"?\))?')

    # C. åŒ¹é…é€šç”¨æ³¨è§£: @RequestMapping(value="/edit", method=RequestMethod.PUT)
    request_mapping_re = re.compile(r'@RequestMapping\((.*?)\)')
    
    for root, _, files in os.walk(source_root):
        for file in files:
            if not file.endswith(".java"): continue
            with open(os.path.join(root, file), 'r', errors='ignore') as f:
                content = f.read()
                
                # æå–ç±»å‰ç¼€è·¯å¾„ (å–ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹)
                base_matches = class_re.findall(content)
                base = base_matches[0].strip("/") if base_matches else ""
                
                # --- ç­–ç•¥1ï¼šå¤„ç†ç®€å†™æ³¨è§£ (@PostMapping) ---
                for m_type, path in method_shorthand_re.findall(content):
                    full_path = _build_path(base, path)
                    _add_api(apis, full_path, m_type.upper())

                # --- ç­–ç•¥2ï¼šå¤„ç†é€šç”¨æ³¨è§£ (@RequestMapping) ---
                # æ‰«ææ‰€æœ‰ @RequestMapping(...) å†…å®¹å¹¶åˆ†æ method
                for params in request_mapping_re.findall(content):
                    # æå– method
                    method_match = re.search(r'method\s*=\s*RequestMethod\.([A-Z]+)', params)
                    final_method = method_match.group(1) if method_match else "GET" # é»˜è®¤ä¸º GET (æˆ–éœ€ç»“åˆä»£ç ä¸Šä¸‹æ–‡ï¼Œæ­¤å¤„ç®€åŒ–)
                    
                    # æå– path (value="...")
                    path_match = re.search(r'(?:value|path)\s*=\s*"?([^",]+)"?', params)
                    # å¦‚æœåªæœ‰å­—ç¬¦ä¸² @RequestMapping("/path")
                    if not path_match and '"' in params:
                         path_match = re.search(r'"([^"]+)"', params)
                    
                    sub_path = path_match.group(1) if path_match else ""
                    
                    # é¿å…ä¸ç®€å†™é‡å¤æå–ï¼ˆç®€å•çš„å»é‡ç­–ç•¥åœ¨ run_extraction ä¸­å¤„ç†ï¼‰
                    full_path = _build_path(base, sub_path)
                    _add_api(apis, full_path, final_method)

    return apis

def _build_path(base, sub):
    sub = sub.strip("/") if sub else ""
    return f"/{base}/{sub}".replace("//", "/")

def _add_api(api_list, path, method):
    # æå–è·¯å¾„å‚æ•°: /user/{userId} -> userId
    path_params = re.findall(r'\{(.*?)\}', path)
    
    api_list.append({
        "path": path,
        "method": method,
        "params": [{"name": p, "in": "path", "required": True} for p in path_params],
        # ä»…ä¸º POST/PUT ç”Ÿæˆ payload ç¤ºä¾‹
        "payload": {"example_key": "example_value"} if method in ["POST", "PUT"] else None
    })

# 2. ç»Ÿä¸€è°ƒåº¦å™¨ï¼šå»é‡å¹¶è¾“å‡º
def run_extraction(config_path):
    with open(config_path, 'r') as f:
        config = json.load(f)
    
    src, lang, work_dir = config['project_path'], config['language'], config['work_dir']
    
    raw_results = []
    if lang.lower() == "java":
        raw_results = extract_java_apis(src)
    
    # [å»é‡å¤„ç†]ï¼šåŸºäº Method + Path å”¯ä¸€æ€§
    unique_map = {}
    for a in raw_results:
        key = f"{a['method']}:{a['path']}"
        if key not in unique_map:
            unique_map[key] = a
            
    return list(unique_map.values()), work_dir
```
## ğŸ åˆ‡æ¢è‡³ [Debugger æ¨¡å¼]
   -  èŒè´£ï¼šæ‰§è¡Œè„šæœ¬ã€éªŒè¯æ•°æ®å®Œæ•´æ€§ã€ç”Ÿæˆæœ€ç»ˆäº¤ä»˜ç‰©ï¼ˆJSON & Markdownï¼‰ã€‚
   -  éªŒè¯ç‚¹ï¼šæ£€æŸ¥ç”Ÿæˆçš„ apis.jsonï¼Œç¡®è®¤æ˜¯å¦åŒ…å«äº† PUT ã€DELETEæ–¹æ³•çš„æ¥å£ï¼Œä»¥åŠè·¯å¾„å‚æ•°æ˜¯å¦è¢«æ­£ç¡®è¯†åˆ«ï¼ˆå¦‚ {userId}ï¼‰ã€‚
```Python

if __name__ == "__main__":
    try:
        final_apis, work_dir = run_extraction("step0_config.json")
        os.makedirs(work_dir, exist_ok=True)
        
        with open(f"{work_dir}/apis.json", 'w', encoding='utf-8') as f:
            json.dump(final_apis, f, indent=2, ensure_ascii=False)
            
        print(f"âœ¨ [Debugger] æå–å®Œæˆï¼Œå…± {len(final_apis)} ä¸ªæ¥å£ã€‚")
    except Exception as e:
        print(f"âŒ [Debugger] é”™è¯¯: {str(e)}")
```
