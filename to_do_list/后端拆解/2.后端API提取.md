# ğŸŸ¢ ä»»åŠ¡ä¸€ï¼šå¤šè¯­è¨€ API æå– (step1_extract.py)

## ğŸ“ å¾…æ‰§è¡ŒæŒ‡ä»¤ï¼š
- [ ] ç¡®è®¤ä¸Šä¸€æ­¥éª¤ä¸­æ‰€å¾—åˆ°çš„æ¨¡å‹è¯†åˆ«ç»“æœï¼Œç¡®å®šå½“å‰éœ€è¦è¯†åˆ«çš„ API è¯­è¨€ï¼Œåœ¨è¿™ä¸€æ­¥éª¤ä»…å®ŒæˆæŒ‡å®šè¯­è¨€çš„API æå–(è„šæœ¬ä¸­ä¸æ¶‰åŠåˆ°å…¶ä»–è¯­è¨€çš„APIæå–é€»è¾‘)
- [ ] åˆ›å»º `step1_extract.py`
- [ ] å°†æœ€åˆä¼ å…¥çš„æºä»£ç æ ¹ç›®å½•è·¯å¾„ç¡¬ç¼–ç è¿›å‡½æ•°ä¸­
- [ ] å®ç°ä¸»å‡½æ•° ï¼ˆè¿™é‡Œä»¥javaä¸ºä¾‹ï¼Œå…¶ä»–è¯­è¨€åŒç†ï¼‰
- [ ] è·å–æºä»£ç æ ¹ç›®å½•è·¯å¾„å®ç°å¸¸è§ API è·¯å¾„æ¨¡å¼æ¢æµ‹åŠŸèƒ½
- [ ] å®ç°å¤šæ–¹æ³•æ¢æµ‹ï¼ˆGET/POST/PUT/DELETE ç­‰ï¼‰
- [ ] å°†æ¢æµ‹ç»“æœä¸é™æ€åˆ†æç»“æœåˆå¹¶
- [ ] åœ¨ step1_extract.py ä¸­é›†æˆåŠ¨æ€æ¢æµ‹ç»“æœ

## ğŸ› ï¸ åˆ‡æ¢è‡³ [Script Engineer æ¨¡å¼]
   - èŒè´£ï¼šå®ç°æ ¸å¿ƒè§£æé€»è¾‘ï¼Œç¡®ä¿å¤šè¯­è¨€å…¼å®¹æ€§ä¸æ•°æ®ç»“æ„ç»Ÿä¸€ã€‚

```Python

import os, re, json

# 1. è¾…åŠ©å‡½æ•°ï¼šç®€å•çš„ Java DTO ç»“æ„è§£æ (ä¸ä»…æ˜¯æå– APIï¼Œè¿˜è¦æå–å‚æ•°ç»“æ„)
def parse_dto_fields(class_name, source_root):
    # ç®€å•çš„é€’å½’æŸ¥æ‰¾ï¼Œåœ¨æºç ä¸­å¯»æ‰¾ class ClassName å®šä¹‰
    # å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„ AST åˆ†æï¼Œè¿™é‡Œç”¨æ­£åˆ™æ¨¡æ‹Ÿ
    fields = {}
    for root, _, files in os.walk(source_root):
        for file in files:
            if file == f"{class_name}.java":
                with open(os.path.join(root, file), 'r', errors='ignore') as f:
                    content = f.read()
                    # åŒ¹é… private String username; å½¢å¼çš„å­—æ®µ
                    # æ’é™¤ static final å¸¸é‡
                    matches = re.findall(r'private\s+(\w+)\s+(\w+);', content)
                    for f_type, f_name in matches:
                        # æ ¹æ®ç±»å‹ç”Ÿæˆé»˜è®¤å€¼
                        if f_type in ['String']: fields[f_name] = "test_data"
                        elif f_type in ['Integer', 'int', 'Long']: fields[f_name] = 1
                        elif f_type in ['Boolean', 'boolean']: fields[f_name] = False
                return fields
    return {"unknown_field": "unknown"} # æœªæ‰¾åˆ°å®šä¹‰æ—¶çš„å›é€€

# 2. æ ¸å¿ƒè§£æé€»è¾‘
def extract_java_apis(source_root):
    apis = []
    # åŒ¹é… Controller ç±»è·¯å¾„
    class_re = re.compile(r'@RequestMapping\("?([^"]*)"?\)')
    # åŒ¹é…æ–¹æ³•ï¼šæ•è· (Method, Path, å‚æ•°åˆ—è¡¨å­—ç¬¦ä¸²)
    # ä¾‹å¦‚: @PostMapping("/login") public AjaxResult login(@RequestBody LoginBody loginBody)
    method_re = re.compile(r'@(Get|Post|Put|Delete)Mapping\("?([^"]*)"?\).*?public.*?\(.*?(.*?)\)')
    
    for root, _, files in os.walk(source_root):
        for file in files:
            if not file.endswith(".java") or "Controller" not in file: continue
            
            with open(os.path.join(root, file), 'r', errors='ignore') as f:
                content = f.read()
                
                # A. æå–ç±»å‰ç¼€ (å¤„ç†ç©ºè·¯å¾„æƒ…å†µ)
                class_matches = class_re.findall(content)
                base_path = class_matches[0].strip("/") if class_matches else ""
                
                # B. æå–æ–¹æ³•çº§æ¥å£
                for m_type, m_path, m_params in method_re.findall(content):
                    # --- ä¿®å¤ 1: è·¯å¾„æ‹¼æ¥é€»è¾‘ ---
                    # é¿å… "/monitor/server" + "/monitor/server" çš„é‡å¤
                    clean_sub = m_path.strip("/")
                    if not clean_sub: 
                        full_path = f"/{base_path}" # æ–¹æ³•è·¯å¾„ä¸ºç©ºï¼Œä»…ä½¿ç”¨ç±»è·¯å¾„
                    else:
                        full_path = f"/{base_path}/{clean_sub}"
                    
                    full_path = full_path.replace("//", "/") # æ¸…ç†åŒæ–œæ 

                    # --- ä¿®å¤ 2: æ™ºèƒ½è½½è·ç”Ÿæˆ ---
                    payload = {}
                    content_type = "application/json"
                    
                    # æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡ä»¶ä¸Šä¼ 
                    if "MultipartFile" in m_params:
                        content_type = "multipart/form-data"
                        payload = {"file": "(binary_file_content)"}
                    
                    # æ£€æŸ¥ @RequestBody å¹¶å°è¯•è§£æ DTO
                    elif "@RequestBody" in m_params and m_type.upper() in ["POST", "PUT"]:
                        # æå–å‚æ•°ç±»å‹ï¼Œä¾‹å¦‚: @RequestBody SysUser user -> æå– SysUser
                        param_match = re.search(r'@RequestBody\s+(\w+)', m_params)
                        if param_match:
                            dto_class = param_match.group(1)
                            # é€’å½’å»æºç é‡Œæ‰¾è¿™ä¸ªç±»çš„å®šä¹‰ï¼Œæå–å­—æ®µ
                            payload = parse_dto_fields(dto_class, source_root)
                        else:
                            payload = {"generic_param": "data"}

                    apis.append({
                        "path": full_path,
                        "method": m_type.upper(),
                        "params": m_params.strip(),
                        "content_type": content_type, # æ–°å¢å­—æ®µ
                        "payload": payload
                    })
    return apis

# 3. ç»Ÿä¸€è°ƒåº¦å™¨ï¼šæ ¹æ®è¯†åˆ«è¯­è¨€è°ƒç”¨è§£æå™¨å¹¶å»é‡
def run_extraction(config_path):
    with open(config_path, 'r') as f:
        config = json.load(f)
    
    src, lang, work_dir = config['project_path'], config['language'], config['work_dir']
    
    # è¯­è¨€è·¯ç”±
    raw_results = []
    if lang.lower() == "java":
        raw_results = extract_java_apis(src)
    # å¯åœ¨æ­¤æ‰©å±• extract_python_apis(src) ç­‰
    
    # [å»é‡å¤„ç†]ï¼šåŸºäº Method + Path å”¯ä¸€æ€§
    unique_data = {f"{a['method']}{a['path']}": a for a in raw_results}.values()
    return list(unique_data), work_dir
```
## ğŸ åˆ‡æ¢è‡³ [Debugger æ¨¡å¼]
   -  èŒè´£ï¼šæ‰§è¡Œè„šæœ¬ã€éªŒè¯æ•°æ®å®Œæ•´æ€§ã€ç”Ÿæˆæœ€ç»ˆäº¤ä»˜ç‰©ï¼ˆJSON & Markdownï¼‰ã€‚

```Python

if __name__ == "__main__":
    try:
        # 1. æ‰§è¡Œæå–é€»è¾‘
        # å‡è®¾ä¸Šä¸€æ­¥ç”Ÿæˆçš„é…ç½®æ–‡ä»¶åä¸º step0_config.json
        final_apis, work_dir = run_extraction("step0_config.json")
        
        # 2. å†™å…¥ apis.json (ä¾›åç»­ä»»åŠ¡ä½¿ç”¨)
        os.makedirs(work_dir, exist_ok=True)
        with open(f"{work_dir}/apis.json", 'w', encoding='utf-8') as f:
            json.dump(final_apis, f, indent=2, ensure_ascii=False)
            
        # 3. åˆå§‹åŒ–å¹¶ç”Ÿæˆ Final_Report.md (Swagger é£æ ¼æ–‡æ¡£)
        with open(f"{work_dir}/Final_Report.md", 'w', encoding='utf-8') as f:
            f.write(f"# ğŸ“– API æ¥å£é›†æˆæ–‡æ¡£\n\n> ç»Ÿè®¡ï¼šå…±å‘ç° **{len(final_apis)}** ä¸ªæœ‰æ•ˆæ¥å£\n\n")
            for api in final_apis:
                f.write(f"--- \n### ğŸ“ `{api['path']}`\n")
                f.write(f"- **Method**: `{api['method']}`\n")
                if api['params']:
                    f.write("- **Parameters**:\n" + "".join([f"  - `{p['name']}` ({p['in']})\n" for p in api['params']]))
                if api['payload']:
                    f.write(f"- **Valid Payload Example**:\n```json\n{json.dumps(api['payload'], indent=2)}\n```\n")
        
        print(f"âœ¨ [Debugger] éªŒè¯é€šè¿‡ï¼šå·²ç”Ÿæˆ {len(final_apis)} æ¡æ¥å£è®°å½•è‡³ {work_dir}")
        
    except Exception as e:
        print(f"âŒ [Debugger] è¿è¡Œå‡ºé”™: {str(e)}")
```
